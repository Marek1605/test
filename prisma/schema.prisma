// ==============================================
// PRISMA SCHEMA - EshopBuilder Platform
// Database: PostgreSQL (Coolify managed)
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// AUTHENTICATION & USERS
// ==============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  name          String?
  image         String?
  phone         String?
  
  // Subscription
  plan          Plan      @default(FREE)
  planExpiresAt DateTime?
  stripeCustomerId String?
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  shops         Shop[]
  aiGenerations AIGeneration[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==============================================
// SUBSCRIPTION PLANS
// ==============================================

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

// ==============================================
// SHOPS (E-SHOPY)
// ==============================================

model Shop {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  
  // Domain Configuration
  subdomain   String   @unique
  customDomain String? @unique
  
  // Branding
  logo        String?
  favicon     String?
  theme       String   @default("default")
  colors      Json?    @default("{\"primary\":\"#6366f1\",\"secondary\":\"#10b981\"}")
  
  // Regional Settings
  currency    String   @default("EUR")
  language    String   @default("sk")
  timezone    String   @default("Europe/Bratislava")
  
  // Contact Information
  email       String?
  phone       String?
  address     Json?
  
  // Business Details (SK/CZ invoicing)
  companyName String?
  ico         String?
  dic         String?
  icDph       String?
  bankAccount String?
  bankIban    String?
  
  // Payment Gateways
  gopayEnabled      Boolean @default(false)
  gopayGoId         String?
  gopayClientId     String?
  gopayClientSecret String?
  gopayTestMode     Boolean @default(true)
  
  comgateEnabled    Boolean @default(false)
  comgateMerchant   String?
  comgateSecret     String?
  comgateTestMode   Boolean @default(true)
  
  stripeEnabled     Boolean @default(false)
  stripePublicKey   String?
  stripeSecretKey   String?
  
  codEnabled        Boolean @default(true)
  bankTransferEnabled Boolean @default(true)
  
  // Shipping Settings
  shippingMethods   Json?   @default("[]")
  freeShippingFrom  Decimal? @db.Decimal(10, 2)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  // Analytics
  googleAnalyticsId String?
  facebookPixelId   String?
  
  // Status
  status      ShopStatus @default(DRAFT)
  publishedAt DateTime?
  
  // Owner
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relations
  products    Product[]
  categories  Category[]
  orders      Order[]
  customers   Customer[]
  pages       Page[]
  coupons     Coupon[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("shops")
}

enum ShopStatus {
  DRAFT
  PUBLISHED
  SUSPENDED
}

// ==============================================
// PRODUCTS
// ==============================================

model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?  @db.Text
  shortDescription String?
  
  // Pricing
  price       Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2)
  costPrice   Decimal? @db.Decimal(10, 2)
  taxRate     Decimal  @db.Decimal(5, 2) @default(20)
  
  // Inventory
  sku         String?
  barcode     String?
  ean         String?
  quantity    Int      @default(0)
  trackInventory Boolean @default(true)
  allowBackorder Boolean @default(false)
  lowStockThreshold Int @default(5)
  
  // Physical Properties
  weight      Decimal? @db.Decimal(10, 3)
  width       Decimal? @db.Decimal(10, 2)
  height      Decimal? @db.Decimal(10, 2)
  depth       Decimal? @db.Decimal(10, 2)
  
  // Media
  images      Json?    @default("[]")
  
  // SEO
  metaTitle   String?
  metaDescription String?
  
  // Status & Visibility
  status      ProductStatus @default(DRAFT)
  featured    Boolean  @default(false)
  
  // Relations
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  variants    ProductVariant[]
  orderItems  OrderItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shopId, slug])
  @@unique([shopId, sku])
  @@index([shopId])
  @@index([categoryId])
  @@index([status])
  @@index([ean])
  @@map("products")
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

model ProductVariant {
  id          String   @id @default(cuid())
  name        String
  sku         String?
  barcode     String?
  
  price       Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2)
  quantity    Int      @default(0)
  
  image       String?
  options     Json     @default("{}")
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  orderItems  OrderItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@map("product_variants")
}

// ==============================================
// CATEGORIES
// ==============================================

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?  @db.Text
  image       String?
  
  position    Int      @default(0)
  
  parentId    String?
  parent      Category? @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryTree")
  
  metaTitle   String?
  metaDescription String?
  
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  products    Product[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shopId, slug])
  @@index([shopId])
  @@index([parentId])
  @@map("categories")
}

// ==============================================
// ORDERS
// ==============================================

model Order {
  id            String   @id @default(cuid())
  orderNumber   String   @unique
  
  // Status
  status        OrderStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  
  // Totals
  subtotal      Decimal  @db.Decimal(10, 2)
  shipping      Decimal  @db.Decimal(10, 2) @default(0)
  tax           Decimal  @db.Decimal(10, 2) @default(0)
  discount      Decimal  @db.Decimal(10, 2) @default(0)
  total         Decimal  @db.Decimal(10, 2)
  currency      String   @default("EUR")
  
  // Payment
  paymentMethod String?
  paymentId     String?
  paidAt        DateTime?
  
  // Shipping
  shippingMethod String?
  shippingCarrier String?
  trackingNumber String?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  
  // Addresses (stored as JSON for flexibility)
  billingAddress  Json
  shippingAddress Json?
  sameAsShipping  Boolean @default(true)
  
  // Customer Reference
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Guest Checkout
  guestEmail    String?
  guestName     String?
  guestPhone    String?
  
  // Notes
  customerNote  String?  @db.Text
  internalNote  String?  @db.Text
  
  // Coupon
  couponCode    String?
  couponDiscount Decimal? @db.Decimal(10, 2)
  
  // Invoice
  invoiceNumber String?
  invoiceUrl    String?
  invoicedAt    DateTime?
  
  // Shop Reference
  shopId        String
  shop          Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  // Order Items
  items         OrderItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([shopId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model OrderItem {
  id          String   @id @default(cuid())
  
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  
  // Snapshot at order time
  productName String
  productSku  String?
  productImage String?
  variantName String?
  variantOptions Json?
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  variantId   String?
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ==============================================
// CUSTOMERS
// ==============================================

model Customer {
  id          String   @id @default(cuid())
  email       String
  password    String?
  
  firstName   String?
  lastName    String?
  phone       String?
  
  // Company details (B2B)
  companyName String?
  ico         String?
  dic         String?
  icDph       String?
  
  // Addresses
  addresses   Json?    @default("[]")
  
  // Marketing
  acceptsMarketing Boolean @default(false)
  
  // Notes & Tags
  note        String?  @db.Text
  tags        String[] @default([])
  
  // Stats
  totalOrders Int      @default(0)
  totalSpent  Decimal  @db.Decimal(10, 2) @default(0)
  lastOrderAt DateTime?
  
  // Shop Reference
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  orders      Order[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shopId, email])
  @@index([shopId])
  @@map("customers")
}

// ==============================================
// COUPONS
// ==============================================

model Coupon {
  id          String   @id @default(cuid())
  code        String
  description String?
  
  // Discount Type
  type        CouponType @default(PERCENTAGE)
  value       Decimal  @db.Decimal(10, 2)
  
  // Restrictions
  minOrderValue Decimal? @db.Decimal(10, 2)
  maxUses     Int?
  usedCount   Int      @default(0)
  perCustomer Int?     @default(1)
  
  // Validity
  startsAt    DateTime?
  expiresAt   DateTime?
  
  // Status
  active      Boolean  @default(true)
  
  // Shop Reference
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shopId, code])
  @@index([shopId])
  @@map("coupons")
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

// ==============================================
// PAGES (Custom pages like About, Contact)
// ==============================================

model Page {
  id          String   @id @default(cuid())
  title       String
  slug        String
  content     String?  @db.Text
  
  // SEO
  metaTitle   String?
  metaDescription String?
  
  // Navigation
  showInNav   Boolean  @default(false)
  navPosition Int      @default(0)
  
  // Status
  published   Boolean  @default(false)
  
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shopId, slug])
  @@index([shopId])
  @@map("pages")
}

// ==============================================
// AI GENERATION LOGS
// ==============================================

model AIGeneration {
  id          String   @id @default(cuid())
  type        String
  prompt      String   @db.Text
  result      String?  @db.Text
  tokens      Int?
  cost        Decimal? @db.Decimal(10, 6)
  model       String   @default("claude-3-haiku")
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shopId      String?
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([shopId])
  @@map("ai_generations")
}
